üõ°Ô∏è Sistema Unificado de Monitoriza√ß√£o de Backups (TechX)Integra√ß√£o CyberPanel/CloudPanel para ZimaOS via TelegramEste documento detalha a implementa√ß√£o de um sistema de relat√≥rios autom√°ticos para validar a integridade de backups em ambientes multi-servidor, enviando os dados para um armazenamento centralizado (ZimaOS) e notificando o administrador via Telegram.üìã Arquitetura do SistemaO sistema baseia-se em scripts Bash leves que verificam tr√™s camadas de dados antes de reportar o estado:Camada de Processo: Analisa logs de erro em tempo real.Camada F√≠sica: Verifica se o ficheiro .tar.gz foi efetivamente criado nas √∫ltimas 24h.Camada de Notifica√ß√£o: Envia um relat√≥rio formatado via API do Telegram.üõ†Ô∏è Scripts de Monitoriza√ß√£o1. Script para CloudPanel (Ubuntu/Debian)Espec√≠fico para detetar atividades do utilizador clp e comandos clpctl.Bashcat << 'EOF' > /usr/local/bin/report_cloudpanel.sh
#!/bin/bash
# --- CONFIGURA√á√ïES ---
TOKEN="7999220153:AAG16TzAOZ5rCUAIY_4pL2EhKanhonVrtok"
CHAT_ID="-1003521688767"
HOSTNAME=$(hostname)

# 1. BUSCA DE DADOS
LOG_ERRORS=$(journalctl --since "24 hours ago" | grep "create_backup.sh" | grep -iE "error|failed|fatal" | tail -n 1)
LOG_ACTIVITY=$(journalctl --since "24 hours ago" | grep -iE "create_backup|clpctl" | grep -ivE "session|pam_unix|sudo" | tail -n 1)

# 2. L√ìGICA DE ESTADO
if [[ -n "$LOG_ERRORS" ]]; then
    ESTADO="üî¥ ERRO"
    DETALHE="Falha real detectada no script de backup."
    EVIDENCIA=$(echo "$LOG_ERRORS" | sed 's/[<>&]//g' | cut -c 1-150)
elif [[ -n "$LOG_ACTIVITY" ]]; then
    ESTADO="üü¢ SAUD√ÅVEL"
    DETALHE="Atividade de backup validada via sistema."
    EVIDENCIA=$(echo "$LOG_ACTIVITY" | sed 's/[<>&]//g' | cut -c 1-150)
else
    BKP_FILES=$(find /home/clp/backups/ -name "*.tar.gz" -mmin -1440 2>/dev/null | head -n 1)
    if [[ -n "$BKP_FILES" ]]; then
        ESTADO="üü¢ SAUD√ÅVEL"
        DETALHE="Backup confirmado via arquivo f√≠sico."
        EVIDENCIA="Arquivo: $(basename $BKP_FILES)"
    else
        ESTADO="‚ö™ AGUARDANDO"
        DETALHE="Sem atividade nas √∫ltimas 24h."
        EVIDENCIA="Verificar agendamento no painel."
    fi
fi

# 3. ENVIO TELEGRAM
MENSAGEM="<b>ü§ñ Relat√≥rio de Integridade: $HOSTNAME</b>%0A------------------------------------%0Aüìå <b>ESTADO:</b> $ESTADO%0A‚ÑπÔ∏è <b>Detalhe:</b> $DETALHE%0A------------------------------------%0Aüìù <b>Evid√™ncia:</b>%0A<code>$EVIDENCIA</code>%0Aüìç <b>Destino:</b> ZimaOS (TechX Storage)"
curl -s --max-time 10 -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" -d "chat_id=$CHAT_ID" -d "text=$MENSAGEM" -d "parse_mode=HTML"
EOF
chmod +x /usr/local/bin/report_cloudpanel.sh
2. Script para CyberPanel (CentOS/Ubuntu)Focado na estrutura de pastas /home/backup e logs do CyberCP.Bashcat << 'EOF' > /usr/local/bin/report_cyberpanel.sh
#!/bin/bash
# --- CONFIGURA√á√ïES ---
TOKEN="7999220153:AAG16TzAOZ5rCUAIY_4pL2EhKanhonVrtok"
CHAT_ID="-1003521688767"
HOSTNAME="$(hostname) (CyberPanel)"

# 1. BUSCA DE DADOS (Verifica arquivos f√≠sicos gerados)
BKP_FILE=$(find /home/ -path "*/backup/*.tar.gz" -mmin -1440 2>/dev/null | head -n 1)

# 2. L√ìGICA DE ESTADO
if [[ -n "$BKP_FILE" ]]; then
    ESTADO="üü¢ SAUD√ÅVEL"
    DETALHE="Backup local conclu√≠do com sucesso."
    EVIDENCIA="Arquivo: $(basename $BKP_FILE)"
else
    ESTADO="‚ö™ AGUARDANDO"
    DETALHE="Backup local n√£o encontrado ou ainda em processamento (RUNNING)."
    EVIDENCIA="Verificar agendamento (Padr√£o: 03:00)."
fi

# 3. ENVIO TELEGRAM
MENSAGEM="<b>ü§ñ Relat√≥rio de Integridade: $HOSTNAME</b>%0A------------------------------------%0Aüìå <b>ESTADO:</b> $ESTADO%0A‚ÑπÔ∏è <b>Detalhe:</b> $DETALHE%0A------------------------------------%0Aüìù <b>Evid√™ncia:</b>%0A<code>$EVIDENCIA</code>%0Aüìç <b>Destino:</b> ZimaOS (TechX Storage)"
curl -s --max-time 10 -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" -d "chat_id=$CHAT_ID" -d "text=$MENSAGEM" -d "parse_mode=HTML"
EOF
chmod +x /usr/local/bin/report_cyberpanel.sh

‚è∞ Agendamento Autom√°tico (Crontab)Configura√ß√£o para envio semanal (Domingos √†s 09:00), garantindo que todos os backups da madrugada j√° terminaram.PainelComando de Instala√ß√£o CronCloudPanel(crontab -l 2>/dev/null; echo "00 09 * * 0 /usr/local/bin/report_cloudpanel.sh > /dev/null 2>&1") | crontab -CyberPanel(crontab -l 2>/dev/null; echo "00 09 * * 0 /usr/local/bin/report_cyberpanel.sh > /dev/null 2>&1") | crontab -üìÅ Gest√£o do ZimaOS (Storage Externo)Todos os backups s√£o enviados para o servidor central atrav√©s de SFTP.Host: techx.esPorta: 2993 (SFTP Port)Caminho Base: /media/storage_8tb/TechX/Estrutura de Pastas Sugerida:/scmm/ -> Backups do Miseric√≥rdia Mogadouro/mail/ -> Backups do TechX Mail/alpha/ -> Backups do Servidor Alpha/ts/ -> Backups da TS-Engenhariaüí° Notas de Seguran√ßaChaves SSH: Recomenda-se o uso de chaves SSH (ssh-copy-id -p 2993) entre as VPS e o ZimaOS para evitar o uso de senhas em texto limpo.Tokens: Antes de partilhar estes scripts publicamente, remova o TOKEN do Telegram e o CHAT_ID.

Desenvolvido por Luciano Milani
